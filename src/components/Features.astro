---
import { fetchProductVariants } from "../lib/shopify.server";

import logo from "../img/logopeque.png";
import testimonio1 from "../img/testimonio1.jpeg";
import testimonio2 from "../img/testimonio2.jpeg";
import pareja from "../img/pareja.jpeg";
import ModalReact from "./react/ModalReact.tsx";

const variants = await fetchProductVariants("8847688794261");
// Tipos
type IconName = "star" | "lock" | "bolt" | "check" | "x";

interface Testimonial {
  name: string;
  role: string;
  image: string;
  text: string;
  date: string;
  rating: number;
}

interface Feature {
  title: string;
  subtitle: string;
  description: string;
  icon: IconName;
  gradient: string;
}

interface Rating {
  stars: number;
  count: number;
  percentage: number;
}

interface ComparisonFeature {
  name: string;
  letraViva: boolean;
  others: boolean;
}

// Datos de testimonios
const testimonials: Testimonial[] = [
  {
    name: "Andrea Betancur",
    role: "Cliente verificada",
    image: pareja.src,
    text: "¡Definitivamente el mejor regalo para alguien que amas, mi esposo no lo podía creer cuando menciona su nombre en el coro jajaj Nos encantó",
    date: "Hace 2 semanas",
    rating: 5,
  },
  {
    name: "Camila Rodriguez",
    role: "Cliente verificada",
    image:testimonio1.src,      
    text: "Es increíble lo emocionada que estaba mi mamá al escuchar su canción, nunca la había visto así, de verdad gracias por que se nota que lo hacen con el corazón.",
    date: "Hace 2 semanas",
    rating: 5,
  },
  {
    name: "",
    role: "Sandra Gomez",
    image:testimonio2.src,
    text: "¡Increíble! Le regalé una canción a mi esposo por nuestro aniversario y lloró de emoción. La calidad es profesional y la letra capturó perfectamente nuestra historia. Definitivamente volveré a pedir otra.",
    date: "Hace 2 semanas",
    rating: 5,
  },
];

// Características principales
const features: Feature[] = [
  {
    title: "Calidad De Audio Profesional",
    subtitle: "Tu canción, con sonido impecable",
    description:
      "Entregamos archivos en formato WAV y MP3 con <span class='font-semibold text-gray-900'>calidad de estudio</span>. Listos para compartir, guardar o reproducir en cualquier plataforma.",
    icon: "star",
    gradient: "from-[#11676a] to-[#00343d]",
  },
  {
    title: "Compra Segura y Protegida",
    subtitle: "Tu información está a salvo",
    description:
      "Usamos <span class='font-semibold text-gray-900'>plataformas seguras</span> para pagos y tus datos están protegidos bajo <span class='font-semibold text-gray-900'>estrictas políticas de privacidad</span>.",
    icon: "lock",
    gradient: "from-[#00343d] to-[#11676a]",
  },
  {
    title: "Entrega Rápida y Puntual",
    subtitle: "Recíbela de 24 a 48 horas o menos",
    description:
      "Creamos y entregamos tu canción personalizada en un máximo de 2 días hábiles. Si la necesitas urgente, <span class='font-semibold text-gray-900'>tenemos opción express de solo 4 horas</span>.",
    icon: "bolt",
    gradient: "from-[#f89a3f] to-[#d67a2f]",
  },
];

// Datos de calificaciones
const ratings: Rating[] = [
  { stars: 5, count: 2953, percentage: 96.84 },
  { stars: 4, count: 134, percentage: 4.16 },
  { stars: 3, count: 0, percentage: 0 },
  { stars: 2, count: 0, percentage: 0 },
  { stars: 1, count: 0, percentage: 0 },
];

// Tabla de comparación
const comparisonFeatures: ComparisonFeature[] = [
  { name: "Atención Directa y Humana", letraViva: true, others: false },
  { name: "Entrega 24-48 Horas", letraViva: true, others: false },
  { name: "Emoción Garantizada", letraViva: true, others: false },
  { name: "Creación Profesional De Estudio", letraViva: true, others: false },
  { name: "Calidad Audio Profesional", letraViva: true, others: true },
  { name: "Revisiones Incluidas", letraViva: true, others: false },
  { name: "Soporte Post-Entrega", letraViva: true, others: false },
];

// Función para renderizar estrellas
const renderStars = (count: number): number[] => {
  return Array(count).fill(0);
};

// Iconos SVG
const icons: Record<IconName, string> = {
  star: `<path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"></path>`,
  lock: `<path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>`,
  bolt: `<path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"></path>`,
  check: `<svg xmlns="http://www.w3.org/2000/svg"
                                            width="24"
                                            height="24"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            class="lucide lucide-check h-5 w-5 text-white"
                                            ><path d="M20 6 9 17l-5-5"
                                            ></path></svg>`,
  x: `<path d="M18 6 6 18"></path><path d="m6 6 12 12"></path>`,
};
---

<section class="container mx-auto max-w-7xl relative z-10 animate-fade-up" id="crear-cancion">
  <div class="text-center my-8">
    <h2 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4 text-balance">
      Regala Una Canción Personalizada Única
    </h2>

    <p class="text-lg text-gray-600 max-w-2xl mx-auto text-pretty">
      Cuéntanos tu historia, todo lo que quieras expresar y lo convertiremos en
      una obra musical única, creada con todo el arte y la sensibilidad de Letra
      Viva
    </p>

    <ModalReact variants={variants} client:load />
  </div>

  <div class="grid lg:grid-cols-2 gap-12 items-start mb-16">
    <!-- Columna Izquierda -->
    <div class="space-y-6">
      <!-- Testimonios - NUEVO DISEÑO SIMPLE -->
      <div class="testimonial-section">
        <div class="text-center ">
          <div class="inline-flex items-center gap-2 bg-gradient-to-r from-[#11676a]/10 to-[#f89a3f]/10 px-4 py-2 rounded-full ">
            <svg class="h-4 w-4 text-[#f89a3f]" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
            </svg>
            <span class="text-xs font-semibold text-gray-700">Testimonios Verificados</span>
          </div>         
        </div>

        <!-- Testimonial actual -->
        <div id="testimonial-display" class="mb-6">
          <!-- Se llenará con JavaScript -->
        </div>

        <!-- Controles -->
        <div class="flex items-center justify-between">
          <button id="prev-testimonial" class="nav-btn">
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 18l-6-6 6-6" />
            </svg>
          </button>

          <div class="flex gap-2" id="dots-container">
            <!-- Dots generados con JS -->
          </div>

          <button id="next-testimonial" class="nav-btn">
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 18l6-6-6-6" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Características -->
      <div class="grid gap-4">
        {
          features.map((feature) => (
            <div class="text-card-foreground flex flex-col gap-6 bg-white border-2 border-gray-200 p-6 shadow-lg rounded-2xl hover:shadow-xl transition-all hover:border-[#11676a]/30">
              <div class="flex items-start gap-4">
                <div
                  class={`flex-shrink-0 w-12 h-12 rounded-xl bg-gradient-to-br ${feature.gradient} flex items-center justify-center shadow-lg`}
                >
                  <svg
                    class="h-6 w-6 text-white"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <Fragment set:html={icons[feature.icon]} />
                  </svg>
                </div>
                <div class="flex-1">
                  <h4 class="font-bold text-gray-900 text-lg mb-2">
                    {feature.title}
                  </h4>
                  <p class="text-gray-600 text-sm mb-3">
                    <span class="font-semibold">{feature.subtitle}</span>
                  </p>
                  <p
                    class="text-gray-600 text-sm"
                    set:html={feature.description}
                  />
                </div>
              </div>
            </div>
          ))
        }
      </div>
    </div>

    <!-- Columna Derecha -->
    <div class="space-y-8">
      <!-- Rating Summary -->
      <div
        class="flex flex-col bg-gradient-to-br from-white to-[#e7ebeb] border-2 border-[#11676a]/20 p-8 shadow-2xl rounded-3xl relative overflow-hidden"
      >
        <div
          class="absolute top-0 right-0 w-32 h-32 bg-[#11676a]/5 rounded-full -translate-y-1/2 translate-x-1/2"
        >
        </div>
        <div class="text-center mb-8">
          <div class="flex items-center justify-center gap-3 mb-1">
            <svg
              class="h-16 w-16 fill-[#f89a3f] text-[#f89a3f]"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <Fragment set:html={icons.star} />
            </svg>
            <div class="text-5xl font-bold text-gray-900">4.9</div>
          </div>
          <p class="text-xl font-semibold text-[#ff6b35]">
            2K+ Clientes Emocionados
          </p>
        </div>
        <div class="space-y-3">
          {
            ratings.map((rating) => (
              <div class="flex items-center gap-3">
                <div class="flex gap-0.5 w-24">
                  {renderStars(rating.stars).map(() => (
                    <svg
                      class="h-4 w-4 fill-[#f89a3f] text-[#f89a3f]"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <Fragment set:html={icons.star} />
                    </svg>
                  ))}
                  {renderStars(5 - rating.stars).map(() => (
                    <svg
                      class="h-4 w-4 fill-gray-200 text-gray-200"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <Fragment set:html={icons.star} />
                    </svg>
                  ))}
                </div>
                <div class="flex-1 h-3 bg-gray-200 rounded-full overflow-hidden">
                  <div
                    class="h-full bg-gradient-to-r from-[#11676a] to-[#2d8c89] rounded-full transition-all"
                    style={`width: ${rating.percentage}%;`}
                  />
                </div>
                <span class="text-sm text-gray-600 w-10 text-right">
                  ({rating.count})
                </span>
              </div>
            ))
          }
        </div>
      </div>

      <!-- Tabla de Comparación -->
      <div
        class="flex flex-col bg-gradient-to-br from-white to-[#e7ebeb] border-2 border-[#11676a]/20 p-8 shadow-2xl rounded-3xl relative overflow-hidden"
      >
        <div
          class="absolute top-0 right-0 w-32 h-32 bg-[#11676a]/5 rounded-full -translate-y-1/2 translate-x-1/2"
        >
        </div>
        <h3 class="text-2xl font-bold text-gray-900 mb-1 text-center">
          ¿Por Qué Elegir Letra Viva?
        </h3>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="border-b-2 border-gray-200">
                <th
                  class="text-left py-4 px-2 text-gray-600 font-semibold text-sm"
                  >Característica</th
                >
                <th class="text-center py-4 px-2">
                  <img
                    src={logo.src}
                    alt="logo"
                    class="w-full h-9 object-contain"
                  />
                </th>
                <th
                  class="text-center py-4 px-2 text-gray-600 font-semibold text-sm"
                  >Otros</th
                >
              </tr>
              <tbody>
                {
                  comparisonFeatures.map((feature) => (
                    <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                      <td class="py-4 px-2 text-gray-700 font-medium text-sm">
                        {feature.name}
                      </td>
                      <td class="py-4 px-2 text-center">
                        <div
                          class={`inline-flex items-center justify-center w-8 h-8 rounded-full ${feature.letraViva ? "bg-gradient-to-br from-[#11676a] to-[#2d8c89]" : "bg-gray-200"}`}
                        >
                          <svg
                            class={`h-5 w-5 ${feature.letraViva ? "text-white" : "text-gray-400"}`}
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                            stroke-width="2"
                          >
                            <Fragment
                              set:html={
                                feature.letraViva ? icons.check : icons.x
                              }
                            />
                          </svg>
                        </div>
                      </td>
                      <td class="py-4 px-2 text-center">
                        <div
                          class={`inline-flex items-center justify-center w-8 h-8 rounded-full ${feature.others ? "bg-gray-400" : "bg-gray-200"}`}
                        >
                          <svg
                            class={`h-5 w-5 ${feature.others ? "text-green-600" : "text-red-500 "}`}
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                            stroke-width="2"
                          >
                            <Fragment
                              set:html={feature.others ? icons.check : icons.x}
                            />
                          </svg>
                        </div>
                      </td>
                    </tr>
                  ))
                }
              </tbody>
            </thead>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .testimonial-section {
    background: linear-gradient(135deg, #ffffff 0%, #e8f5f5 100%);
    border: 2px solid rgba(17, 103, 106, 0.2);
    padding: 1.5rem;
    border-radius: 1.5rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  }

  .testimonial-card {
    background: white;
    border: 1px solid rgba(17, 103, 106, 0.15);
    padding: 1.25rem;
    border-radius: 1.25rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    min-height: 240px;
  }

  .nav-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #11676a, #2d8c89);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px rgba(17, 103, 106, 0.3);
  }

  .nav-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(17, 103, 106, 0.4);
  }

  .nav-btn:active {
    transform: scale(0.95);
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: rgba(17, 103, 106, 0.3);
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
  }

  .dot.active {
    width: 24px;
    border-radius: 4px;
    background: linear-gradient(90deg, #11676a, #2d8c89);
  }
</style>

<script is:inline define:vars={{ testimonials }}>
  document.addEventListener('DOMContentLoaded', function() {
    let currentIndex = 0;
    let autoplayInterval;

    const display = document.getElementById('testimonial-display');
    const dotsContainer = document.getElementById('dots-container');
    const prevBtn = document.getElementById('prev-testimonial');
    const nextBtn = document.getElementById('next-testimonial');

    function createTestimonialHTML(testimonial) {
      const stars = Array(testimonial.rating).fill(0).map(() => 
        `<svg class="h-4 w-4 fill-[#f89a3f] text-[#f89a3f]" viewBox="0 0 24 24">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
        </svg>`
      ).join('');

      return `
        <div class="testimonial-card">
          <div class="flex items-start gap-3 mb-4">
            <div class="flex-shrink-0">
              <div class="w-14 h-14 rounded-full bg-gradient-to-br from-[#11676a] to-[#2d8c89] p-0.5">
                <div class="w-full h-full rounded-full bg-white flex items-center justify-center overflow-hidden">
                  <img alt="${testimonial.name}" class="w-full h-full object-cover" src="${testimonial.image}" />
                </div>
              </div>
            </div>
            <div class="flex-1">
              <h4 class="font-bold text-gray-900 text-base mb-1">${testimonial.name}</h4>
              <p class="text-xs text-gray-600 flex items-center gap-1">
                <svg class="h-3 w-3 text-green-500" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                ${testimonial.role}
              </p>
            </div>
          </div>
          <div class="flex items-center gap-1 mb-3">${stars}</div>
          <blockquote class="text-gray-700 text-sm leading-relaxed mb-3">"${testimonial.text}"</blockquote>
          <div class="flex items-center gap-2 text-xs text-gray-500">
            <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" />
              <path d="M12 6v6l4 2" />
            </svg>
            ${testimonial.date}
          </div>
        </div>
      `;
    }

    function updateDisplay() {
      if (display) {
        display.innerHTML = createTestimonialHTML(testimonials[currentIndex]);
      }
      
      // Update dots
      document.querySelectorAll('.dot').forEach((dot, index) => {
        dot.classList.toggle('active', index === currentIndex);
      });
    }

    function next() {
      currentIndex = (currentIndex + 1) % testimonials.length;
      updateDisplay();
    }

    function prev() {
      currentIndex = (currentIndex - 1 + testimonials.length) % testimonials.length;
      updateDisplay();
    }

    function goTo(index) {
      currentIndex = index;
      updateDisplay();
    }

    function startAutoplay() {
      stopAutoplay();
      autoplayInterval = setInterval(next, 5000);
    }

    function stopAutoplay() {
      if (autoplayInterval) clearInterval(autoplayInterval);
    }

    // Create dots
    if (dotsContainer) {
      testimonials.forEach((_, index) => {
        const dot = document.createElement('button');
        dot.className = 'dot';
        dot.addEventListener('click', () => {
          goTo(index);
          stopAutoplay();
          startAutoplay();
        });
        dotsContainer.appendChild(dot);
      });
    }

    // Event listeners
    if (prevBtn) {
      prevBtn.addEventListener('click', () => {
        prev();
        stopAutoplay();
        startAutoplay();
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        next();
        stopAutoplay();
        startAutoplay();
      });
    }

    // Initialize
    updateDisplay();
    startAutoplay();

    // Pause on hover
    if (display) {
      display.addEventListener('mouseenter', stopAutoplay);
      display.addEventListener('mouseleave', startAutoplay);
    }
  });
</script>